# JCoSapRfcLink 리팩토링 기록

## 2024-05-15

### 1. 현재 상황 분석
- JCoSAPServer 클래스에서 JCo 3.x API 관련 컴파일 에러 발생
- 주요 문제점:
  1. JCoFunctionTemplate 생성 방식 오류
  2. JCoCustomRepository의 함수 등록 메서드 오류
  3. JCoServer의 핸들러 설정 메서드 오류

### 2. 패키지 구조 및 네이밍 분석
#### 2.1 현재 구조
```
jco.jcosaprfclink
├── config
│   ├── aop
│   └── saprfc
│       ├── SapRFCConnection.java
│       └── JCoConnectionManager.java
├── controller
├── domain
├── dto
├── exception
├── repository
├── service
├── type
└── utils
```

#### 2.2 개선이 필요한 부분
1. **패키지 구조**
   - `config.saprfc` 패키지가 너무 단순한 구조
   - SAP RFC 관련 클래스들이 한 패키지에 모두 모여있음
   - 인터페이스와 구현체가 분리되어 있지 않음

2. **네이밍 컨벤션**
   - `SapRFCConnection`과 `JCoConnectionManager`의 네이밍이 일관성이 없음
   - SAP와 JCo가 혼용되어 있음
   - Connection과 Manager의 역할 구분이 불명확

#### 2.3 제안하는 구조
```
jco.jcosaprfclink
├── config
│   ├── aop
│   └── saprfc
│       ├── connection
│       │   ├── SapRfcConnection.java (interface)
│       │   └── JCoSapRfcConnection.java (impl)
│       ├── server
│       │   ├── SapRfcServer.java (interface)
│       │   └── JCoSapRfcServer.java (impl)
│       ├── handler
│       │   ├── SapRfcFunctionHandler.java (interface)
│       │   └── JCoSapRfcFunctionHandler.java (impl)
│       └── properties
│           ├── SapRfcProperties.java
│           └── SapRfcServerProperties.java
```

### 3. 리팩토링 계획
1. 패키지 구조 개선
   - SAP RFC 관련 클래스들을 기능별로 분리
   - 인터페이스와 구현체 분리
   - properties 클래스 분리

2. 네이밍 컨벤션 통일
   - SAP RFC 관련 클래스는 'SapRfc' 접두어 사용
   - JCo 구현체는 'JCo' 접두어 사용
   - 역할에 따른 명확한 네이밍 적용

3. 단계별 리팩토링 진행
   - 패키지 구조 변경
   - 클래스 네이밍 변경
   - JCo 3.x API 적용

### 4. Connection 클래스 리팩토링 (2024-05-15)
#### 4.1 변경 사항
1. **패키지 구조 변경**
   - `config.saprfc.connection` 패키지 생성
   - 인터페이스와 구현체 분리

2. **클래스 네이밍 변경**
   - `SapRFCConnection` → `SapRfcConnection` (인터페이스)
   - `JCoConnectionManager` → `JCoSapRfcConnection` (구현체)

3. **코드 개선**
   - 메서드 분리 및 가독성 향상
   - 상수 값 분리
   - 예외 처리 개선
   - 주석 추가

#### 4.2 주요 변경 내용
1. **인터페이스 정의**
   ```java
   public interface SapRfcConnection {
       void initialize();
       JCoDestination getConnection() throws JCoException;
       void startRfcServer();
       void setImportParameters(List<Map<String, Object>> inputMapList, String inputTabName, JCoFunction jCoFunction);
       List<Map<String, Object>> getExportParameters(String outputTabName, JCoFunction jCoFunction);
   }
   ```

2. **구현체 개선**
   - 생성자 주입 방식으로 변경
   - 메서드 분리 (createDestinationProperties, createServerProperties)
   - 상수 값 분리 (SERVER_NAME, DESTINATION_NAME)
   - 예외 처리 개선

#### 4.3 다음 단계
- Server 클래스 리팩토링 진행
- Handler 클래스 리팩토링 진행
- Properties 클래스 분리

### 5. 참고 사항
- 현재 브랜치: feature/jco-server-refactoring
- 주요 변경 파일: 
  - SapRfcConnection.java (interface)
  - JCoSapRfcConnection.java (impl)
- 관련 설정 파일: application.yml, application-test-local.yml 

---

## 2024-05-17 ~ 2024-05-19

### 1. 핸들러별 로깅 요구 및 적용
- 각 핸들러에서 어떤 함수가 어떤 데이터로 호출되는지 명확히 로그로 남기도록 개선
- `doHandleRequest`/`handleRequest` 시작, 종료, 예외 발생 시 로그 추가
- 로그에 핸들러명, 함수명, 주요 파라미터, 예외 메시지 포함

### 2. 핸들러 자동 등록 구조 논의
- 기존에는 코드에서 직접 핸들러를 등록
- 개선 방향으로 `application.yml`에서 함수명-핸들러명 매핑 방식 제안 및 구조 설계

### 3. JCoServerFunctionHandler 구현 및 호출 구조 점검
- 핸들러가 `JCoServerFunctionHandler`를 반드시 구현해야 하는지 확인 요청
- SAP JCo 서버가 자동으로 호출하려면 반드시 해당 인터페이스 구현 필요
- `AbstractRfcHandler`가 이미 구현하고 있으면 자식 클래스도 자동 구현됨

### 4. RFC 호출 미동작 원인 분석
- SAP에서 RFC 호출 시 Java 쪽 로그가 찍히지 않는 현상 발생
- SAP와 Java 서버 간 네트워크, Program ID, Gateway, Function Name 등 환경/설정 문제 가능성 안내
- SAP SM59/SMGW, Java 서버 로그, 네트워크 방화벽 등 점검 요청

### 5. JcoSapConnector 오픈소스 구조 참고
- [JcoSapConnector](https://github.com/minya8703/JcoSapConnector.git) 오픈소스 구조가 잘 동작함을 확인
- 순수 Java 방식, 파일 기반 설정, 명확한 핸들러 등록 구조의 장점 설명
- Spring 기반 구조와의 차이점 및 장단점 비교

### 6. 컴파일 오류 및 코드 수정
- 핸들러 import 누락, 오타(한글 문자), 메서드 시그니처 불일치 등 컴파일 오류 발생
- import 추가, 오타 삭제, `throws JCoException` 제거, 예외 처리 방식 변경 등으로 해결

### 7. Spring JPA open-in-view 경고 안내
- `spring.jpa.open-in-view` 기본 활성화로 인한 경고 메시지 발생
- API 서버에서는 `open-in-view: false`로 설정 권장
- `application.yml`/`application.properties`에 설정 추가 방법 안내

---

## 2024-05-20

### 1. ClassCastException 및 인터페이스 구현 오류 해결
- `TaxInvoiceStateHandler`가 `SapRfcServerHandler`를 구현하지 않아 `ClassCastException` 발생 → 인터페이스 구현 추가로 해결

### 2. 핸들러 등록 방식 application.yml 기반으로 변경
- `JCoSapRfcConnection`에서 함수명-핸들러명 매핑을 동적으로 처리하도록 개선

### 3. API 호출 실패 시 SAP로 에러 메시지 전달
- HTTP 요청 실패 시 SAP로 에러 메시지(`ERR_CODE`, `ERR_MSG`)를 테이블에 세팅하여 반환하도록 로직 개선

### 4. 서비스 구조 및 응답 매핑 리팩토링
- API 호출 및 응답 매핑을 `HttpUtil`과 `JsonPaserUtil`을 활용해 일원화
- 성공/실패 응답에 따라 SAP 테이블 필드(`RESULT`, `ERR_CODE`, `ERR_MSG` 등) 명확하게 구분
- 코드 가독성 및 유지보수성 향상을 위해 메서드 분리 및 로깅 개선

---

## 참고
- `application.yml`에서 SAP RFC 함수와 핸들러 매핑 예시:
  ```yaml
  sap:
    rfc:
      functions:
        - name: ZFI_TAXINV_STATUS_TO_WEB
          handler: taxInvoiceStateHandler
  ```
- API 호출 예시:
  - URL: `${api.dev_url}/resultTaxInvoice`
  - HTTP 메서드: POST
  - 본문: JSON 배열

--- 